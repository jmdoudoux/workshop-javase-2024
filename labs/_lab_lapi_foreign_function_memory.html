<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Lab : l&#8217;API Foreign Function &amp; Memory</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./rouge-github.css">
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="_lab_lapi_foreign_function_memory" class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<p><span class="toc-root"><a href="lab-ffm.html">Lab : l&#8217;API Foreign Function &amp; Memory</a></span></p><ul class="sectlevel3">
<li><a href="lab-ffm.html#_lab_lapi_foreign_function_memory"><span class="toc-current">1. Lab : l&#8217;API Foreign Function &amp; Memory</span></a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect3">
<h4 id="_lab_lapi_foreign_function_memory"><a class="anchor" href="#_lab_lapi_foreign_function_memory"></a>1. Lab : l&#8217;API Foreign Function &amp; Memory</h4>
<div class="paragraph">
<p>Depuis le JDK 1.1, il est possible de manipuler des données "off-heap" et d&#8217;interagir avec du code natif via l&#8217;API JNI : "Java Native Interface" :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>L&#8217;appel à des fonctions natives se fait via l&#8217;utilisation du modificateur <code>native</code> et d&#8217;une "glue" en langage natif permettant de faire le lien entre code C et Java dans laquelle il faudra effectuer les conversions des types de données</p>
</li>
<li>
<p>La gestion de la mémoire "off-heap" peut être réalisée via <code>ByteBuffer::allocateDirect</code> et <code>sun.misc.Unsafe</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces fonctionnalités présentent un certain nombre d&#8217;inconvénients :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lourdeur de mise en œuvre, nécessité d&#8217;écrire du code natif</p>
</li>
<li>
<p>Gestion manuelle de la mémoire</p>
</li>
<li>
<p>Performance</p>
</li>
<li>
<p><code>Unsafe</code> est non standard et devant à terme être remplacée</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;API Foreign Function &amp; Memory "FFM" a pour ambition de fournir un moyen sûr et performant de répondre à ces problématiques.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Première incubation en Java 14 <a href="https://openjdk.org/jeps/412">JEP 412</a>. Standard en Java 22</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JEP</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openjdk.org/jeps/454">JEP 454: Foreign Function &amp; Memory API</a></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_la_gestion_de_la_mémoire_off_heap"><a class="anchor" href="#_la_gestion_de_la_mémoire_off_heap"></a>1.1. La gestion de la mémoire "off-heap"</h5>
<div class="paragraph">
<p>La mémoire "off-heap" fait référence à la mémoire allouée en dehors du tas (heap).
Cette zone mémoire n&#8217;est donc pas gérée par la JVM ni soumise à la collecte par le Garbage Collector.</p>
</div>
<div class="paragraph">
<p>L&#8217;API FFM nous propose une représentation de la mémoire "off-heap" sous la forme de l&#8217;interface <code>MemorySegment</code>.
Un tel objet peut être obtenu par l&#8217;intermédiaire d&#8217;une <code>Arena</code> qui implémente l&#8217;interface <code>AutoCloseable</code> et va en contrôler la portée en nous permettant de déterminer à quel moment la mémoire allouée à ce segment sera libérée.</p>
</div>
<div class="paragraph">
<p>Une instance de l&#8217;interface <code>Arena</code> peut être obtenue via l&#8217;une de ses 4 fabriques : <code>global()</code>, <code>ofAuto()</code>, <code>ofConfined()</code> et <code>ofShared()</code>.
Ces <code>Arena</code> diffèrent par les propriétés suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>L&#8217;accessibilité aux segments depuis le thread qui a créé l'<code>Arena</code> ou depuis n&#8217;importe quel thread</p>
</li>
<li>
<p>La durée de vie des segments alloués</p>
</li>
<li>
<p>La possibilité ou non de libérer explicitement les segments alloués</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces différences sont synthétisées dans ce tableau :</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-center valign-top">Durée de vie limitée</th>
<th class="tableblock halign-center valign-top">Arrêt explicite possible</th>
<th class="tableblock halign-center valign-top">Accessible depuis plusieurs threads</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✗</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✗</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatic</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✗</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Confined</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✗</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>Arena</code> possède des surcharges des méthodes <code>allocate()</code> et <code>allocateFrom()</code> permettant d&#8217;allouer un <code>MemorySegment</code>.</p>
</div>
<div class="paragraph">
<p>Il est ensuite possible de lire dans un <code>MemorySegment</code> via les méthodes <code>get()</code>, <code>getAtIndex()</code> ou <code>getString()</code>, et d&#8217;écrire via les méthodes <code>set()</code>, <code>setAtIndex()</code> ou <code>setString()</code>.</p>
</div>
<div class="paragraph">
<p>Une fois alloué, la dimension d&#8217;un <code>MemorySegment</code> ne peut plus être modifiée.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Tout accès en lecture ou écriture en dehors des bornes du segment lève une exception de type <code>IndexOutOfBoundsException</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_lécriture_et_la_lecture_de_chaînes_de_caractères"><a class="anchor" href="#_lécriture_et_la_lecture_de_chaînes_de_caractères"></a>1.2. L&#8217;écriture et la lecture de chaînes de caractères</h5>
<div class="paragraph">
<p>Écrire et lire des chaînes de caractères via un <code>MemorySegment</code> se fait de manière simple.
L&#8217;API se charge des considérations techniques d&#8217;encodage et de décodage, notamment du caractère de terminaison de chaînes de caractères en C <code>\0</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>allocateFrom()</code> permet d&#8217;initialiser un <code>MemorySegment</code> à partir d&#8217;une chaîne de caractères</p>
</li>
<li>
<p><code>setString()</code> et <code>getString()</code> permettent respectivement d&#8217;écrire et lire une chaîne de caractères avec un offset donné</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Chacune de ces méthodes possède une surcharge permettant de spécifier le <code>Charset</code> à utiliser, <code>UTF-8</code> étant utilisé par défaut.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Compléter la méthode <code>manipulerChaineDeCaracteres()</code> de <code>fr.sciam.workshop.javase.ffm.MainFFM</code> afin d&#8217;utiliser une <code>Arena</code> de type "confined" pour allouer un <code>MemorySegment</code> à partir de la chaîne de caractères "Hello FFM".</p>
</div>
<div class="paragraph">
<p>Ensuite, lire et afficher le contenu de cette chaîne de caractères depuis le <code>MemorySegment</code>.</p>
</div>
<div class="paragraph">
<p>Afficher également la taille en octet de ce <code>MemorySegment</code> grâce à la méthode <code>byteSize()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerChaineDeCaracteres</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocateFrom</span><span class="o">(</span><span class="s">"Hello FFM"</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">memorySegment</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">.</span><span class="na">byteSize</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'une chaîne de caractères :
Hello FFM
10</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On constate une taille de 10 octets, un octet supplémentaire ayant été nécessaire pour stocker le caractère de terminaison de chaîne de caractères <code>\0</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lécriture_et_la_lecture_de_types_primitifs"><a class="anchor" href="#_lécriture_et_la_lecture_de_types_primitifs"></a>1.3. L&#8217;écriture et la lecture de types primitifs</h5>
<div class="paragraph">
<p>Chacune des méthodes <code>get()</code>/<code>getAtIndex()</code> et <code>set()</code>/<code>setAtIndex()</code> nécessite en paramètre une instance de type <code>ValueLayout</code> qui explicite la structure de la donnée à lire ou écrire.
Il s&#8217;agit d&#8217;une interface scellée dont les implémentations correspondent aux différents types primitifs du langage Java (<code>boolean</code>, <code>byte</code>, <code>int</code>, <code>double</code>, &#8230;&#8203;) et contient les informations nécessaires :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la taille de la donnée,</p>
</li>
<li>
<p>son boutisme (little ou big endian),</p>
</li>
<li>
<p>l&#8217;alignement,</p>
</li>
<li>
<p>le type de la donnée Java correspondante.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
L&#8217;alignement contraint les données à ce qu&#8217;elles soient stockées à des adresses mémoire particulières, par exemple des multiples de 4 octets pour les entiers, pour des raisons de performances d&#8217;accès. Des octets de "padding" peuvent être ajoutés pour respecter cet alignement.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
La notion de classes scellées est abordée dans le lab <a href="lab-classes-scellees.html#classes-scellees">les classes scellées</a>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Dans la méthode <code>manipulerEntiers()</code>, allouer un <code>MemorySegment</code> d&#8217;une taille de 32 octets.</p>
</div>
<div class="paragraph">
<p>Ensuite, réaliser l&#8217;écriture puis la lecture de chacune des valeurs contenues dans le tableau <code>ENTIERS</code> à l&#8217;aide des méthodes <code>set()</code> et <code>get()</code>. Celles-ci se basent sur la position (en octets) à laquelle on souhaite accéder : il faut donc incrémenter cette position après chaque itération pour accéder à la donnée suivante.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerEntiers</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">32</span><span class="o">);</span>

      <span class="c1">// Ecriture</span>
      <span class="kt">long</span> <span class="n">increment</span> <span class="o">=</span> <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">.</span><span class="na">byteSize</span><span class="o">();</span> <span class="c1">// 4 octets</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">memorySegment</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">increment</span><span class="o">,</span> <span class="no">ENTIERS</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
      <span class="o">}</span>

      <span class="c1">// Lecture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">entier</span> <span class="o">=</span> <span class="n">memorySegment</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">increment</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">entier</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'entiers
0 123 456 789 -1 -2 -3 -4</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Les méthodes <code>getAtIndex()</code> et <code>setAtIndex()</code> sont plus adaptées à notre cas de figure, car elles prennent comme paramètre l&#8217;index de la donnée, et effectuent en interne le calcul de la position en multipliant par la taille.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Modifier la méthode <code>manipulerEntiers()</code> afin d&#8217;utiliser <code>getAtIndex()</code> et <code>setAtIndex()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerEntiers</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">32</span><span class="o">);</span>

      <span class="c1">// Ecriture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">memorySegment</span><span class="o">.</span><span class="na">setAtIndex</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="no">ENTIERS</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
      <span class="o">}</span>

      <span class="c1">// Lecture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">entier</span> <span class="o">=</span> <span class="n">memorySegment</span><span class="o">.</span><span class="na">getAtIndex</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">entier</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient le même résultat :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'entiers
0 123 456 789 -1 -2 -3 -4</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_les_memory_layouts_et_les_accès_structurés"><a class="anchor" href="#_les_memory_layouts_et_les_accès_structurés"></a>1.4. Les Memory layouts et les accès structurés</h5>
<div class="paragraph">
<p>Accéder à des données structurées en mémoire en ne se limitant qu&#8217;à des opérations basiques s&#8217;avérerait limitant.
L&#8217;API FFM fournit l&#8217;interface <code>MemoryLayout</code> qui permet de définir une structuration de la donnée et d&#8217;y accéder de manière simplifiée. Plusieurs possibilités sont offertes au travers de certaines de ses interfaces filles :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StructLayout</code> pour une structure agrégeant plusieurs données,</p>
</li>
<li>
<p><code>SequenceLayout</code> pour une répétition d&#8217;une donnée ou structure de données,</p>
</li>
<li>
<p><code>PaddingLayout</code> pour une plage non utilisée (typiquement pour de l&#8217;alignement),</p>
</li>
<li>
<p><code>UnionLayout</code> pour définir des unions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Une fois le layout défini, la méthode <code>varHandle()</code> renvoie un <code>VarHandle</code> permettant d&#8217;accéder à un élément de la structure. Cette méthode accepte des paramètres de type <code>MemoryLayout.PathElement</code>, dont le choix définira l&#8217;élément auquel on accède.</p>
</div>
<div class="paragraph">
<p>Les paramètres de type <code>MemoryLayout.PathElement</code> peuvent s&#8217;obtenir via les fabriques :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>groupElement()</code> pour obtenir un élément à partir de son index ou son nom au sein d&#8217;un groupe,</p>
</li>
<li>
<p><code>sequenceElement()</code> pour obtenir un élément au sein d&#8217;un <code>SequenceLayout</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>Arena</code> possède une surcharge de la méthode <code>allocate()</code> qui accepte un <code>MemoryLayout</code> afin d&#8217;allouer un <code>MemorySegment</code> de la taille correspondante.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_le_layout_structlayout"><a class="anchor" href="#_le_layout_structlayout"></a>1.4.1. Le layout <code>StructLayout</code></h6>
<div class="paragraph">
<p><code>MemoryLayout::structLayout</code> permet de définir une structure de données à partir des <code>MemoryLayout</code> qui la constituent.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Consulter le <code>record</code> <code>CoordonneesGps</code>, puis dans la méthode <code>manipulerStructLayout()</code>, créer un layout représentant cette structure de données en mémoire.</p>
</div>
<div class="paragraph">
<p>Puis, allouer un <code>MemorySegment</code> pour y écrire la première coordonnée GPS du tableau <code>COORDONNEES_GPS</code> avec le layout créé.
On utilisera <code>MemoryLayout.PathElement::groupElement(index)</code> pour accéder aux éléments : index <code>0</code> pour la latitude, index <code>1</code> pour la longitude.</p>
</div>
<div class="paragraph">
<p>Enfin, lire les valeurs dans le <code>MemorySegment</code> via le <code>VarHandle</code> pour vérifier que les données ont correctement été écrites, aux bons emplacements.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
le concept de <code>record</code> est abordé dans le lab <a href="lab-records.html#records">les Records</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerStructLayout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">StructLayout</span> <span class="n">structLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">structLayout</span><span class="o">(</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span>
      <span class="o">);</span>

      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">structLayout</span><span class="o">);</span>

      <span class="nc">VarHandle</span> <span class="n">latitudeHandle</span> <span class="o">=</span> <span class="n">structLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
      <span class="nc">VarHandle</span> <span class="n">longitudeHandle</span> <span class="o">=</span> <span class="n">structLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>

      <span class="nc">CoordonneesGps</span> <span class="n">coordonnees</span> <span class="o">=</span> <span class="no">COORDONNEES_GPS</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
      <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">latitude</span><span class="o">());</span>
      <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">longitude</span><span class="o">());</span>

      <span class="kt">float</span> <span class="n">latitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
      <span class="kt">float</span> <span class="n">longitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ecrit : "</span> <span class="o">+</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">latitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", lu : "</span> <span class="o">+</span> <span class="n">latitude</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ecrit : "</span> <span class="o">+</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">longitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", lu : "</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'un StructLayout
Ecrit : 43.1242, lu : 43.1242
Ecrit : 5.9285, lu : 5.9285</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Les <code>MemoryLayout</code> passés en paramètres peuvent être nommés via la méthode <code>withName()</code>.
On pourra ensuite utiliser ces noms pour obtenir les chemins des éléments <code>MemoryLayout.PathElement</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Modifier la méthode <code>manipulerStructLayout()</code> afin de nommer les <code>ValueLayout</code> et d&#8217;utiliser les noms choisis pour obtenir les <code>VarHandle</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerStructLayout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">StructLayout</span> <span class="n">structLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">structLayout</span><span class="o">(</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">.</span><span class="na">withName</span><span class="o">(</span><span class="s">"latitude"</span><span class="o">),</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">.</span><span class="na">withName</span><span class="o">(</span><span class="s">"longitude"</span><span class="o">)</span>
      <span class="o">);</span>

      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">structLayout</span><span class="o">);</span>

      <span class="nc">VarHandle</span> <span class="n">latitudeHandle</span> <span class="o">=</span> <span class="n">structLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="s">"latitude"</span><span class="o">));</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="nc">VarHandle</span> <span class="n">longitudeHandle</span> <span class="o">=</span> <span class="n">structLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="s">"longitude"</span><span class="o">));</span>

      <span class="nc">CoordonneesGps</span> <span class="n">coordonnees</span> <span class="o">=</span> <span class="no">COORDONNEES_GPS</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
      <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">latitude</span><span class="o">());</span>
      <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">longitude</span><span class="o">());</span>

      <span class="kt">float</span> <span class="n">latitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
      <span class="kt">float</span> <span class="n">longitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ecrit : "</span> <span class="o">+</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">latitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", lu : "</span> <span class="o">+</span> <span class="n">latitude</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ecrit : "</span> <span class="o">+</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">longitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", lu : "</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nommage des éléments de la structure</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtention du chemin de l&#8217;élément avec le nom choisi</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient le même résultat :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'un StructLayout
Ecrit : 43.1242, lu : 43.1242
Ecrit : 5.9285, lu : 5.9285</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_le_layout_sequencelayout"><a class="anchor" href="#_le_layout_sequencelayout"></a>1.4.2. Le layout <code>SequenceLayout</code></h6>
<div class="paragraph">
<p><code>SequenceLayout</code> permet de définir une répétition d&#8217;un champ ou structure.</p>
</div>
<div class="paragraph">
<p>Les surcharges de <code>PathElement::sequenceElement</code> permettent d&#8217;obtenir les <code>VarHandle</code> permettant de lire et écrire au sein d&#8217;une séquence.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Utiliser un <code>SequenceLayout</code> pour écrire le contenu du tableau <code>ENTIERS</code> dans un <code>MemorySegment</code>, à l&#8217;aide du <code>VarHandle</code> obtenu avec le <code>PathElement</code> renvoyé par <code>PathElement.sequenceElement()</code>.</p>
</div>
<div class="paragraph">
<p>Enfin, lire les valeurs dans le <code>MemorySegment</code> via le <code>VarHandle</code> pour vérifier que les données ont correctement été écrites, aux bons emplacements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerSequenceLayout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>

      <span class="nc">SequenceLayout</span> <span class="n">sequenceLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">sequenceLayout</span><span class="o">(</span><span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">);</span>
      <span class="nc">VarHandle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">sequenceLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">sequenceElement</span><span class="o">());</span>

      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">sequenceLayout</span><span class="o">);</span>

      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">handle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="no">ENTIERS</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
      <span class="o">}</span>

      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">entier</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">handle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">entier</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'un SequenceLayout
0 123 456 789 -1 -2 -3 -4</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_la_combinaison_dun_structlayout_et_sequencelayout"><a class="anchor" href="#_la_combinaison_dun_structlayout_et_sequencelayout"></a>1.4.3. La combinaison d&#8217;un <code>StructLayout</code> et <code>SequenceLayout</code></h6>
<div class="paragraph">
<p>Il est possible de combiner les layouts.
Si l&#8217;on souhaite répéter plusieurs fois la même structure, l&#8217;utilisation conjointe de <code>StructLayout</code> et <code>SequenceLayout</code> est adaptée.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Compléter la méthode <code>manipulerStructLayoutDansSequenceLayout()</code> afin d&#8217;écrire puis lire les valeurs de <code>COORDONNEES_GPS</code> en utilisant conjointement <code>StructLayout</code> et <code>SequenceLayout</code> des mises en pratique précédentes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerStructLayoutDansSequenceLayout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>

      <span class="c1">// Structure</span>
      <span class="nc">StructLayout</span> <span class="n">structLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">structLayout</span><span class="o">(</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">.</span><span class="na">withName</span><span class="o">(</span><span class="s">"latitude"</span><span class="o">),</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">.</span><span class="na">withName</span><span class="o">(</span><span class="s">"longitude"</span><span class="o">)</span>
      <span class="o">);</span>

      <span class="c1">// Sequence</span>
      <span class="nc">SequenceLayout</span> <span class="n">sequenceLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">sequenceLayout</span><span class="o">(</span><span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">structLayout</span><span class="o">);</span>

      <span class="c1">// Obtention des VarHandle</span>
      <span class="nc">PathElement</span> <span class="n">element</span> <span class="o">=</span> <span class="nc">PathElement</span><span class="o">.</span><span class="na">sequenceElement</span><span class="o">();</span>
      <span class="nc">VarHandle</span> <span class="n">latitudeHandle</span> <span class="o">=</span> <span class="n">sequenceLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="s">"latitude"</span><span class="o">));</span>
      <span class="nc">VarHandle</span> <span class="n">longitudeHandle</span> <span class="o">=</span> <span class="n">sequenceLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="s">"longitude"</span><span class="o">));</span>

      <span class="c1">// Allocation d'un segment dont la taille correspond à la structure</span>
      <span class="nc">MemorySegment</span> <span class="n">segment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">sequenceLayout</span><span class="o">);</span>

      <span class="c1">// Écriture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">COORDONNEES_GPS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">CoordonneesGps</span> <span class="n">c</span> <span class="o">=</span> <span class="no">COORDONNEES_GPS</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">latitude</span><span class="o">());</span>
        <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">longitude</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="c1">// Lecture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">COORDONNEES_GPS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">float</span> <span class="n">latitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="kt">float</span> <span class="n">longitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Latitude : "</span> <span class="o">+</span> <span class="n">latitude</span> <span class="o">+</span> <span class="s">", Longitude "</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'un StructLayout dans un SequenceLayout
Latitude : 43.1242, Longitude 5.9285
Latitude : 43.1176, Longitude 5.9404
Latitude : 43.0928, Longitude 6.0756
Latitude : 43.1055, Longitude 5.8869</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lappel_de_fonctions_natives"><a class="anchor" href="#_lappel_de_fonctions_natives"></a>1.5. L&#8217;appel de fonctions natives</h5>
<div class="paragraph">
<p>L&#8217;API FFM met à dispositions les moyens permettant la recherche et le chargement de bibliothèques natives ainsi que l&#8217;invocation de fonctions native (downcall), ou l&#8217;appel de méthodes Java depuis le code natif (upcall).</p>
</div>
<div class="sect5">
<h6 id="_la_recherche_et_le_chargement_de_bibliothèques_natives"><a class="anchor" href="#_la_recherche_et_le_chargement_de_bibliothèques_natives"></a>1.5.1. La recherche et le chargement de bibliothèques natives</h6>
<div class="paragraph">
<p>Chaque bibliothèque adhère à une "Application Binary Interface" (ABI) qui est un ensemble de conventions et types de données qui dépendent du système d&#8217;exploitation, du compilateur et du processeur.
L&#8217;interface <code>Linker</code> a connaissance de ces conventions et joue le rôle de médiateur entre le code Java et le code natif.</p>
</div>
<div class="paragraph">
<p>Une instance de <code>Linker</code> s&#8217;obtient via la fabrique <code>nativeLinker()</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>SymbolLookup</code> permet de fournir un accès aux bibliothèques et fonctions natives qui adhèrent aux spécifications de la plateforme.
Pour en obtenir une instance, on dispose de 3 fabriques :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SymbolLookup.libraryLookup(String, arena)</code> et <code>SymbolLookup.libraryLookup(Path, arena)</code> permettent de charger dynamiquement une bibliothèque par son nom ou son chemin et en liant son cycle de vie à celui de l'<code>Arena</code>,</p>
</li>
<li>
<p><code>SymbolLookup.loaderLookup()</code> crée un <code>SymbolLookup</code> qui recherchera dans les bibliothèques chargées par le <code>ClassLoader</code>, par exemple via <code>System.load()</code> ou <code>System.loadLibrary()</code> comme on le ferait avec JNI.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ainsi que de la méthode <code>Linker.defaultLookup()</code> qui permet de rechercher parmi un ensemble de bibliothèques standard, telle que la bibliothèque <code>libc</code> sous Linux.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Dans la suite de ce lab, nous allons manipuler la bibliothèque <a href="https://www.sqlite.org/">SQLite</a> qui est écrite en langage C et permet de créer et interagir avec une base de données locale.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Compléter la méthode <code>chargerBibliothequeNative()</code> dans le but de charger la bibliothèque sqlite3 correspondant à votre système d&#8217;exploitation présente dans le répertoire <code>sqlite/</code> via son <code>Path</code>.
Ajouter un message indiquant le succès de chargement puis renvoyer l&#8217;instance de <code>SymbolLookup</code> obtenue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">SymbolLookup</span> <span class="nf">chargerBibliothequeNativeAvecPath</span><span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Path</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"sqlite/sqlite3.dll"</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="nc">SymbolLookup</span> <span class="n">lookup</span> <span class="o">=</span> <span class="nc">SymbolLookup</span><span class="o">.</span><span class="na">libraryLookup</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">arena</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Bibliothèque chargée avec succès"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">lookup</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>.dll sous Windows, .so sous Linux et .dylib sous MacOS</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Chargement de la bibliothèque sqlite3
Bibliothèque chargée avec succès

WARNING: A restricted method in java.lang.foreign.SymbolLookup has been called
WARNING: java.lang.foreign.SymbolLookup::libraryLookup has been called by fr.sciam.workshop.javase.ffm.MainFFM in an unnamed module
WARNING: Use --enable-native-access=ALL-UNNAMED to avoid a warning for callers in this module
WARNING: Restricted methods will be blocked in a future release unless native access is enabled</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Les méthodes de l&#8217;API FFM annotées <code>@Restricted</code> ne sont pas "sûres".
Les interactions entre code Java et natif comportent des risques intrinsèques. Une utilisation incorrecte peut amener des problèmes tels qu&#8217;une corruption de la mémoire pouvant amener à un crash de la JVM.
Il est nécessaire d&#8217;autoriser explicitement ces opérations pour ne pas obtenir le warning obtenu ci-dessus.</p>
</div>
<div class="paragraph">
<p>S&#8217;il ne s&#8217;agit que d&#8217;un warning à l&#8217;heure actuelle, la <a href="https://openjdk.org/jeps/472">JEP 472</a> prévoit à l&#8217;avenir de lever une exception à la place.</p>
</div>
<div class="paragraph">
<p>Pour autoriser l&#8217;appel aux méthodes restreintes, il faut ajouter l&#8217;option :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--enable-native-access=ALL-UNNAMED</code> pour des classes chargées du classpath,</p>
</li>
<li>
<p><code>--enable-native-access=M1,M2</code> pour autoriser explicitement pour les modules M1 et M2.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Ajouter l&#8217;option <code>--enable-native-access=ALL-UNNAMED</code> puis exécuter à nouveau la classe <code>MainFFM</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si besoin, se référer à la <a href="index.html#options-jvm">mise en œuvre des options de la JVM</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vérifier qu&#8217;il n&#8217;y a plus d&#8217;avertissement affiché :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Chargement de la bibliothèque sqlite3
Bibliothèque chargée avec succès</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_la_localisation_dune_fonction_native"><a class="anchor" href="#_la_localisation_dune_fonction_native"></a>1.5.2. La localisation d&#8217;une fonction native</h6>
<div class="paragraph">
<p><code>SymbolLookup</code> nous permet de localiser l&#8217;adresse mémoire correspondant à la fonction, via sa méthode <code>find()</code>.
Son type de retour est <code>Optional&lt;MemorySegment&gt;</code>, ce qui permet de gérer le cas où la recherche aurait échoué.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Compléter la méthode <code>localiserFonctionNativeOpen</code> afin de localiser la fonction native <code>sqlite3_open()</code> et afficher puis renvoyer le <code>MemorySegment</code> correspondant.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemorySegment</span> <span class="nf">localiserFonctionNativeOpen</span><span class="o">(</span><span class="nc">SymbolLookup</span> <span class="n">lookup</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="s">"sqlite3_open"</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fonction sqlite3_open() : "</span> <span class="o">+</span> <span class="n">memorySegment</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">memorySegment</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Localisation de la fonction sqlite3_open()
Fonction sqlite3_open() : MemorySegment{ address: 0x7ff89c77324c, byteSize: 0 }</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_linvocation_dune_fonction_native_downcall"><a class="anchor" href="#_linvocation_dune_fonction_native_downcall"></a>1.5.3. L&#8217;invocation d&#8217;une fonction native (downcall)</h6>
<div class="paragraph">
<p><code>Linker</code> nous permet d&#8217;obtenir une instance de <code>MethodHandle</code> sur la fonction native.
Pour l&#8217;invoquer, il faut fournir une description de la signature de la méthode.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>FunctionDescriptor</code> via sa fabrique <code>of()</code> permet de définir le type de retour et les paramètres acceptés par la méthode.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Compte tenu de la description de la fonction native <code>sqlite3_open()</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="nf">sqlite3_open</span><span class="p">(</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>   <span class="cm">/* Database filename (UTF-8) */</span>
  <span class="n">sqlite3</span> <span class="o">**</span><span class="n">ppDb</span>          <span class="cm">/* OUT: SQLite db handle */</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>obtenirMethodHandleOpen()</code> pour obtenir le <code>MethodHandle</code> vers la fonction, puis l&#8217;invoquer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MethodHandle</span> <span class="nf">obtenirMethodHandleOpen</span><span class="o">(</span><span class="nc">Linker</span> <span class="n">linker</span><span class="o">,</span> <span class="nc">MemorySegment</span> <span class="n">memorySegment</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">FunctionDescriptor</span> <span class="n">descripteur</span> <span class="o">=</span> <span class="nc">FunctionDescriptor</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
      <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="o">);</span>

    <span class="nc">MethodHandle</span> <span class="n">methodHandle</span> <span class="o">=</span> <span class="n">linker</span><span class="o">.</span><span class="na">downcallHandle</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="n">descripteur</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MethodHandle obtenu : "</span> <span class="o">+</span> <span class="n">methodHandle</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">methodHandle</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Type de retour de la méthode</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Type du premier paramètre : pointeur vers le nom du fichier <code>.db</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Type du second paramètre : pointeur vers un handle de la base de données</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Obtention d'un MethodHandle vers sqlite3_open()
MethodHandle obtenu : MethodHandle(MemorySegment,MemorySegment)int</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Le <code>MethodHandle</code> peut être invoqué en lui fournissant en paramètres les <code>MemorySegment</code> correspondant aux types attendus.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Compléter la méthode <code>invoquerFonctionOpen()</code> en préparant les paramètres sous forme de <code>MemorySegment</code> puis en invoquant la méthode <code>sqlite3_open()</code> via son <code>MethodHandle</code> précédemment obtenu.</p>
</div>
<div class="paragraph">
<p>Afficher le code de retour obtenu (vaut <code>0</code> si l&#8217;opération est un succès).</p>
</div>
<div class="paragraph">
<p>Enfin, renvoyer le <code>MemorySegment</code> correspondant au pointeur vers la base de données (2ème paramètre de la fonction <code>sqlite3_open()</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemorySegment</span> <span class="nf">invoquerFonctionOpen</span><span class="o">(</span><span class="kd">final</span> <span class="nc">MethodHandle</span> <span class="n">handle</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Arena</span> <span class="n">arena</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">nomFichierBaseDeDonnees</span> <span class="o">=</span> <span class="s">"sqlite/ffm.db"</span><span class="o">;</span>
    <span class="nc">MemorySegment</span> <span class="n">segmentNomFichier</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocateFrom</span><span class="o">(</span><span class="n">nomFichierBaseDeDonnees</span><span class="o">);</span>
    <span class="nc">MemorySegment</span> <span class="n">pointeurBase</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">handle</span><span class="o">.</span><span class="na">invokeExact</span><span class="o">(</span><span class="n">segmentNomFichier</span><span class="o">,</span> <span class="n">pointeurBase</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Lien avec la base "</span> <span class="o">+</span> <span class="n">nomFichierBaseDeDonnees</span> <span class="o">+</span> <span class="s">" établi avec succès"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">pointeurBase</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Erreur au chargement de la base : code = "</span> <span class="o">+</span> <span class="n">code</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Erreur lors de l'invocation de la fonction native sqlite3_open"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Invocation de la fonction sqlite3_open()
Lien avec la base sqlite/ffm.db établi avec succès</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_lappel_montant_natif_vers_java_upcall"><a class="anchor" href="#_lappel_montant_natif_vers_java_upcall"></a>1.5.4. L&#8217;appel montant : natif vers Java (upcall)</h6>
<div class="paragraph">
<p>L&#8217;interface <code>Linker</code> permet également de réaliser des upcalls, à savoir des appels montants depuis le code natif jusqu&#8217;au code Java.</p>
</div>
<div class="paragraph">
<p>Cela se réalise par le biais de la méthode <code>upcallStub()</code> qui prendre en paramètres :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un <code>MethodHandle</code> de la fonction Java à appeler depuis le code natif</p>
</li>
<li>
<p>Une description de cette fonction sous la forme de <code>FunctionDescriptor</code></p>
</li>
<li>
<p>Une instance de type <code>Arena</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
La fonction native <code>sqlite3_trace_v2()</code> permet de configurer des traces avec l&#8217;appel d&#8217;une fonction callback.
Sa signature est la suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">SQLITE_API</span> <span class="kt">int</span> <span class="nf">sqlite3_trace_v2</span><span class="p">(</span>
  <span class="n">sqlite3</span><span class="o">*</span><span class="p">,</span>
  <span class="kt">unsigned</span> <span class="n">uMask</span><span class="p">,</span>
  <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">xCallback</span><span class="p">)(</span><span class="kt">unsigned</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">pCtx</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La méthode de callback Java a déjà été définie : il s&#8217;agit de <code>tracerCallback()</code>.
Constater que sa signature correspond à la fonction de callback attendue par <code>sqlite3_trace_v2()</code>.</p>
</div>
<div class="paragraph">
<p>Dans la méthode <code>configurerUpcall()</code> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utiliser <code>MethodHandles::lookup</code> pour obtenir un <code>MethodHandle</code> sur la méthode <code>tracerCallback()</code>,</p>
</li>
<li>
<p>créer un <code>FunctionDescriptor</code> correspondant,</p>
</li>
<li>
<p>configurer l&#8217;upcall grâce à <code>Linker::upcallStub</code>,</p>
</li>
<li>
<p>enfin, afficher puis renvoyer l&#8217;instance de <code>MethodHandle</code> correspondant à l&#8217;upcall.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemorySegment</span> <span class="nf">configurerUpcall</span><span class="o">(</span><span class="nc">Linker</span> <span class="n">linker</span><span class="o">,</span> <span class="nc">Arena</span> <span class="n">arena</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// Obtention du MethodHandle vers la méthode Java de callback</span>
      <span class="nc">MethodHandle</span> <span class="n">tracerCallbackHandle</span> <span class="o">=</span> <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">lookup</span><span class="o">().</span><span class="na">findStatic</span><span class="o">(</span>
        <span class="nc">MainFFM</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="s">"tracerCallback"</span><span class="o">,</span>
        <span class="nc">MethodType</span><span class="o">.</span><span class="na">methodType</span><span class="o">(</span>
          <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">MemorySegment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">MemorySegment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">MemorySegment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">MemorySegment</span><span class="o">.</span><span class="na">class</span>
        <span class="o">)</span>
      <span class="o">);</span>

      <span class="c1">// Descripteur de la méthode Java de callback</span>
      <span class="nc">FunctionDescriptor</span> <span class="n">tracerCallbackDesc</span> <span class="o">=</span> <span class="nc">FunctionDescriptor</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span>
      <span class="o">);</span>

      <span class="c1">// Création de l'upcall</span>
      <span class="nc">MemorySegment</span> <span class="n">upcall</span> <span class="o">=</span> <span class="n">linker</span><span class="o">.</span><span class="na">upcallStub</span><span class="o">(</span><span class="n">tracerCallbackHandle</span><span class="o">,</span> <span class="n">tracerCallbackDesc</span><span class="o">,</span> <span class="n">arena</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Upcall obtenu : "</span> <span class="o">+</span> <span class="n">upcall</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">upcall</span><span class="o">;</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
La méthode <code>invoquerTraceAvecCallbackPuisRequeter()</code> déjà existante se charge d&#8217;appeler la fonction <code>sqlite3_trace_v2()</code> pour configurer les traces avec l&#8217;upcall, ainsi que de réaliser une requête SQL en base pour déclencher l&#8217;appel au callback.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Configuration de l'appel montant (upcall)
Upcall obtenu : MemorySegment{ address: 0x1324c8a0ca0, byteSize: 0 }

Invocation de sqlite3_trace_v2() avec callback et requête en base
Appel de tracerCallback()
MemorySegment{ address: 0x1, byteSize: 0 }
MemorySegment{ address: 0x0, byteSize: 0 }
MemorySegment{ address: 0x132a70713c0, byteSize: 0 }
MemorySegment{ address: 0x132a7073aa0, byteSize: 0 }</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_les_fonctions_natives_renvoyant_un_pointeur"><a class="anchor" href="#_les_fonctions_natives_renvoyant_un_pointeur"></a>1.5.5. Les fonctions natives renvoyant un pointeur</h6>
<div class="paragraph">
<p>Certaines fonctions natives peuvent renvoyer un pointeur vers une région mémoire.
La JVM n&#8217;a pas la possibilité de connaître la taille ni la structure de cette région, ni même sa durée de vie.
Pour cela, l&#8217;API utilise un <code>MemorySegment</code> de taille nulle pour représenter ce type de pointeur.
Ceci est utilisé pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les pointeurs renvoyés par une fonction native</p>
</li>
<li>
<p>Les pointeurs passés depuis le code natif vers un upcall</p>
</li>
<li>
<p>Les pointeurs lus depuis un <code>MemorySegment</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il est impossible de manipuler directement un tel MemorySegment, sous peine de voir la JVM lever l&#8217;exception <code>IndexOutOfBoundsException</code>.
En effet, elle ne peut pas accéder ou valider en toute sécurité une opération d&#8217;accès à une région mémoire dont la taille est inconnue.</p>
</div>
<div class="paragraph">
<p>La méthode <code>MemorySegment::reinterpret</code> permet de travailler sur de tels segments en y accédant de manière sûre et en rattachant la zone mémoire associée à une <code>Arena</code>.</p>
</div>
<div class="paragraph">
<p>Il existe plusieurs surcharges de cette méthode dont les paramètres font intervenir :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La taille en octet à laquelle le segment va être redimensionné</p>
</li>
<li>
<p>L'<code>Arena</code> à associer avec le <code>MemorySegment</code></p>
</li>
<li>
<p>Une action à exécuter lorsque l'<code>Arena</code> sera fermée, sous la forme d&#8217;un <code>Consumer&lt;MemorySegment&gt;</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>{kb}<br>
Avec SQLite, lorsque l&#8217;on exécute une requête via <code>sqlite3_exec()</code>, on doit fournir le paramètre <code>char **errmsg</code> qui est un pointeur vers la chaîne de caractères contenant un éventuel message d&#8217;erreur.</p>
</div>
<div class="paragraph">
<p>La taille de cette chaîne étant inconnue, il est nécessaire d&#8217;utiliser la méthode <code>MemorySegment::reinterpret</code> pour en lire le contenu, en y affectant une taille arbitraire, mais suffisante.</p>
</div>
<div class="paragraph">
<p>Modifier la chaîne de caractères <code>REQUETE</code> de la classe <code>MainFFM</code> afin d&#8217;ajouter volontairement une erreur de syntaxe pour lever une erreur lors de l&#8217;exécution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">REQUETE</span> <span class="o">=</span> <span class="s">"xxxSELECT * FROM users"</span><span class="o">;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ajout des caractères 'xxx' pour lever une erreur de syntaxe</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ensuite, compléter la méthode <code>traiterMessageErreur()</code> afin de lire le message d&#8217;erreur et l&#8217;afficher.
On utilisera une taille de <code>500</code> octets lors de la réinterprétation du <code>MemorySegment</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemorySegment</span> <span class="nf">traiterMessageErreur</span><span class="o">(</span><span class="nc">MemorySegment</span> <span class="n">pointeur</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">MemorySegment</span> <span class="n">segmentReinterprete</span> <span class="o">=</span> <span class="n">pointeur</span><span class="o">.</span><span class="na">reinterpret</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">segmentReinterprete</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Erreur : "</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">segmentReinterprete</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Erreur : near "xxxSELECT": syntax error</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p></p>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-06-23 17:53:25 +0200
</div>
</div>
</body>
</html>